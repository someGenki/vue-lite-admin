# å‚è€ƒ https://docs.github.com/cn/get-started
# å»ºç«‹ä¸€ä¸ªåä¸º CI çš„å·¥ä½œæµ(éå¿…è¦å±æ€§ï¼Œé»˜è®¤å€¼ä¸ºæ–‡ä»¶å)  â€œåœ¨ä»€ä¹ˆäº‹ä»¶è§¦å‘ï¼Œåœ¨å“ªä¸ªç¯å¢ƒä¸‹ï¼Œè¦åšå“ªäº›ä»»åŠ¡â€
name: ci
# ç›‘å¬Githubä»“åº“ main åˆ†æ”¯ä¸Šçš„pushäº‹ä»¶
on:
  push:
    branches: [ main ]
# å®šä¹‰è¦åšå“ªäº›ä»»åŠ¡ â˜…
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest    # æŒ‡å®šè™šæ‹Ÿæœºç‰ˆæœ¬
    steps: # â˜… æŒ‡å®šè¯¥ä»»åŠ¡æœ‰å“ªäº›æ­¥éª¤
      - uses: actions/checkout@v2         # 1. è·å–é¡¹ç›®æºç 

      - uses: actions/setup-node@v2.5.1   # 2. è®¾ç½® node.js ç¯å¢ƒ
        with:
          node-version: 16.x

      #  yarnç¼“å­˜ https://github.com/actions/cache/blob/main/examples.md#node---yarn
      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "::set-output name=dir::$(yarn cache dir)"
      - uses: actions/cache@v2
        id: yarn-cache # use this to check for `cache-hit` (`steps.yarn-cache.outputs.cache-hit != 'true'`)
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - run: yarn install && npx vite build --base=/admin/    # 3. å®‰è£…ä¾èµ–å¹¶æ‰“åŒ…æ„å»º

      - name: Deploy to Server (ALI SAS) ğŸš€        # 4. éƒ¨ç½²åˆ°é˜¿é‡Œè½»é‡çº§æœåŠ¡å™¨ä¸Š
        uses: easingthemes/ssh-deploy@v2.2.11     # https://github.com/easingthemes/ssh-deploy
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}
          REMOTE_USER: root
          REMOTE_HOST: 47.100.95.40
          SOURCE: ./dist/
          TARGET: /www/html/admin/

      - run:  npx vite build --base=/vue-lite-admin/  # 5. é‡æ–°æ„å»ºä¸€ä»½æ‰“åŒ…æ–‡ä»¶ æŒ‡å®šbaseä¸º <project name>

      - name: Deploy to Github page ğŸš€                 # 6. éƒ¨ç½²åˆ°github pagesä¸Š
        uses: JamesIves/github-pages-deploy-action@v4.2.3
        with:
          branch: gh-pages
          folder: dist
          single-commit: true

